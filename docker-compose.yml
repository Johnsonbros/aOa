# =============================================================================
# aOa - Angle O(1)f Attack
# Docker Compose Configuration
# =============================================================================
#
# IMPORTANT: Configuration is in .env (same directory)
#   - PROJECTS_ROOT: Where your projects live (mounted to /userhome)
#   - GATEWAY_PORT: Service port (default 8080)
#   - Claude sessions auto-derived from PROJECTS_ROOT/.claude
#
# After editing .env, restart with: docker-compose down && docker-compose up -d
#
# Network Architecture:
#   - Internal network (NO internet) for all services except proxy
#   - Single gateway port exposed to user
#   - Proxy has controlled internet access (whitelisted URLs only)
#
# =============================================================================
# Configuration is loaded from .env file in this directory.
# =============================================================================

services:
  # ===========================================================================
  # Gateway - Single entry point (ONLY exposed port)
  # ===========================================================================
  gateway:
    build:
      context: ./services/gateway
      dockerfile: Dockerfile
    ports:
      - "127.0.0.1:${GATEWAY_PORT:-8080}:8080"
    environment:
      - INDEX_URL=http://index:9999
      - STATUS_URL=http://status:9998
      - PROXY_URL=http://proxy:9997
    networks:
      - aoa-internal
      - aoa-external  # Needed for port publishing (internal networks block it)
    depends_on:
      - index
      - status
      - proxy
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"

  # ===========================================================================
  # Index - Codebase search and intent tracking (NO internet)
  # ===========================================================================
  index:
    build:
      context: ./services
      dockerfile: index/Dockerfile
    volumes:
      - ${CODEBASE_PATH:-.}:/codebase:ro
      - ./data/repos:/repos:ro
      - ./data:/config:rw
      - ${PROJECTS_ROOT}:/userhome:ro     # User projects (from .env)
    environment:
      - CODEBASE_ROOT=
      - REPOS_ROOT=/repos
      - CONFIG_DIR=/config
      - INDEXES_DIR=/config/indexes
      - REDIS_URL=redis://redis:6379/0
      - PYTHONUNBUFFERED=1
      - CLAUDE_SESSIONS=/userhome/.claude  # Derived from PROJECTS_ROOT
      - USER_HOME=${PROJECTS_ROOT}         # For path translation (from .env)
    networks:
      - aoa-internal
    depends_on:
      - redis
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"

  # ===========================================================================
  # Status - Session metrics (NO internet)
  # ===========================================================================
  status:
    build:
      context: ./services/status
      dockerfile: Dockerfile
    volumes:
      - ${PROJECTS_ROOT}:/userhome:ro     # Access Claude sessions via /userhome/.claude
    environment:
      - REDIS_URL=redis://redis:6379/0
      - CLAUDE_SESSIONS=/userhome/.claude  # Derived from PROJECTS_ROOT
      - INDEX_URL=http://index:9999
    networks:
      - aoa-internal
    depends_on:
      - redis
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"

  # ===========================================================================
  # Redis - Hot-path storage (NO internet)
  # ===========================================================================
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru --loglevel warning
    volumes:
      - redis-data:/data
    networks:
      - aoa-internal
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"

  # ===========================================================================
  # Proxy - Controlled internet access (whitelisted URLs only)
  # ===========================================================================
  proxy:
    build:
      context: ./services/proxy
      dockerfile: Dockerfile
    volumes:
      - ./repos:/repos:rw
      - ./.aoa:/config:ro
    environment:
      - REPOS_ROOT=/repos
      - WHITELIST_FILE=/config/whitelist.txt
      - MAX_REPO_SIZE_MB=500
      - CLONE_TIMEOUT=300
    networks:
      - aoa-internal   # Can talk to other services
      - aoa-external   # Can reach internet (whitelisted only)
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"

# =============================================================================
# Networks
# =============================================================================

networks:
  # Internal - NO internet access
  # The 'internal: true' flag prevents containers from reaching internet
  aoa-internal:
    driver: bridge
    internal: true

  # External - ONLY for proxy
  # Only proxy service is on this network
  aoa-external:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================

volumes:
  redis-data:
    driver: local
  repos-data:
    driver: local
